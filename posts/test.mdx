---
title: test ì œëª©
emoji: ğŸ˜Š
createdAt: 2023-07-02
tags:
  - tag1
  - tag2
---

ê¸€ë‚´ìš©ì„ ì—¬ê¸°ì— ì“°ëŠ”ê²ë‹ˆë‹¤.

- test

## ì†Œì œëª©

ì´ë²ˆ í¬ìŠ¤íŒ…ì—ì„œëŠ” GraphQL ì—ì„œ N+1 ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•œ ì†”ë£¨ì…˜ì¸ DataLoaderì— ëŒ€í•œ ì†Œê°œì™€ GraphQL ì— DataLoaderë¥¼ ì–´ë–¤ì‹ìœ¼ë¡œ ì ìš©í•´ì•¼ë˜ëŠ”ì§€ë¥¼ ì •ë¦¬í•´ë³´ë ¤ê³  í•œë‹¤.

## N+1 ë¬¸ì œ

N+1 ë¬¸ì œëŠ” ORMì„ ì‚¬ìš©í• ë•Œ ì£¼ë¡œ ë°œìƒí•˜ëŠ” ì„±ëŠ¥ ë¬¸ì œì´ë‹¤.

`Post` ì—”í‹°í‹°ì™€ `Comment` ì—”í‹°í‹°ê°€ ìˆë‹¤ê³  ê°€ì •í•´ë³´ì. ì´ ì—”í‹°í‹°ê°„ì˜ ê´€ê³„ëŠ” `1:N`ìœ¼ë¡œ ì •ì˜í•  ìˆ˜ ìˆë‹¤. Post ëª©ë¡ê³¼ postì— í•´ë‹¹í•˜ëŠ” commentsë¥¼ ì¡°íšŒí•˜ë ¤ í•œë‹¤ë©´ comment entityê°€ lazy loadingë˜ë©´ì„œ N(ê°ê°ì˜ comments ì¡°íšŒ) + 1(post ì¡°íšŒ) ë§Œí¼ ì¿¼ë¦¬ê°€ ì‹¤í–‰ë˜ì„œ N+1 ë¬¸ì œë¼ê³  ë¶€ë¥¸ë‹¤.

í•´ê²°ë°©ë²•ìœ¼ë¡œëŠ” lazy loadingì„ í•˜ëŠ” ëŒ€ì‹  ë¯¸ë¦¬ JOIN ì—°ì‚°ì„ í†µí•´ fetchí•˜ëŠ” ë°©ë²•ì„ ìƒê°í•  ìˆ˜ ìˆë‹¤. ì—¬ê¸°ì— ëŒ€í•œ ë°©ë²•ì€ ORM ë§ˆë‹¤ ì°¨ì´ê°€ ìˆì„ ìˆ˜ ìˆë‹¤.

```typescript
// TypeORM example
// lazy
const posts = await Post.find({})
const comments = await Promise.all(
  posts.map(async p => {
    // TypeORMì—ì„œ lazy relation ê²½ìš° p.comments ëŠ” promise array ì´ë‹¤.
    const comments = await p.comments
    return comments
  }),
)

// eager
const posts = await Post.find({ relations: ['comments'] })
```

## GraphQL ì—ì„œì˜ N+1 ë¬¸ì œ

ì—ì„œ ë°œìƒí•˜ëŠ” N+1ë¬¸ì œë„ ìœ„ì™€ ë¹„ìŠ·í•˜ë‹¤.
ìœ„ì—ì„œì˜ ì—”í‹°í‹°ê´€ê³„ë¥¼ GraphQL SDLë¡œ ì‘ì„±í•˜ë©´ ì•„ë˜ì™€ ê°™ë‹¤.

```graphql
type Post {
  id: Int!
  title: String!
  content: String!
  comments: [Comment!]!
}

type Comment {
  id: Int!
  content: String!
}

type Query {
  posts: [Post!]!
}
```

post ëª©ë¡ê³¼ comments ë¥¼ ê°€ì ¸ì˜¤ëŠ” queryë¥¼ ì‘ì„±í•´ë³´ì.

```graphql
query {
  posts {  # posts query (1)
    id
    title
    content
    comments { # comments query (N) -> Post ê°œìˆ˜ë§Œí¼
      id
      ...
    }
  }
}
```

ìœ„ì™€ ê°™ì´ comments ë¶€ë¶„ì—ì„œ ì„±ëŠ¥ë¬¸ì œê°€ ë°œìƒí•˜ê²Œ ëœë‹¤.
GraphQL ì—ì„œ resolverë¥¼ êµ¬ì„±í•˜ëŠ” ì „ëµì€ ì—¬ëŸ¬ê°€ì§€ê°€ ìˆê² ì§€ë§Œ ë³´í†µ ë‹¤ë¥¸ typeê³¼ ê´€ê³„ê°€ ìˆëŠ” ê²½ìš° resolverë¥¼ ë¶„ë¦¬í•´ì„œ êµ¬í˜„í•˜ëŠ” ê²½ìš°ê°€ ë§ê¸° ë•Œë¬¸ì´ë‹¤.

```javascript
const resolver = {
  Query: {
    posts: async () => {
      return Post.find({})
    },
  },
  Post: {
    // posts queryë¥¼ í˜¸ì¶œí• ê²½ìš° post ê°œìˆ˜(N) ë§Œí¼ í˜¸ì¶œëœë‹¤.
    comments: async root => {
      return Comment.find({ where: { postId: root.id } })
    },
  },
}
```

ë¬¼ë¡  ì•„ë˜ì™€ ê°™ì´ posts resolverì—ì„œ dataë¥¼ join í•´ì„œ fetchí›„ì— return í•œë‹¤ë©´ N+1 ë¬¸ì œëŠ” ë°œìƒí•˜ì§€ ì•Šì„ ìˆ˜ ìˆë‹¤.

```typescript
const resovler = {
  Query: {
    posts: async () => {
      const posts = await Post.find({ relations: ['comments'] })
      return posts
    },
  },
}

/*
query {
  posts {
    id
    title
    content
  }
}
*/
```

í•˜ì§€ë§Œ ìœ„ì™€ ê°™ì´ resolverë¥¼ êµ¬í˜„í•œë‹¤ë©´ queryì—ì„œ comments field ë¥¼ ìš”ì²­í•˜ì§€ ì•Šì•„ë„ joiní•´ì„œ fetchí•´ì„œ dataë¥¼ ê°€ì ¸ì˜¤ê²Œëœë‹¤. clientì—ì„œ ë°›ëŠ” ë°ì´í„°ëŠ” over fetchingì´ ì¼ì–´ë‚˜ì§€ ì•Šì§€ë§Œ ì‹¤ì œ ë°ì´í„°ë¥¼ loadí•˜ëŠ” ê³³ì—ì„œëŠ” over fetchingì´ ì¼ì–´ë‚˜ê³  ìˆëŠ” ê²ƒì´ë‹¤.

## DataLoader

DataLoaderëŠ” data fetch í• ë•Œ ë‚˜íƒ€ë‚˜ëŠ” N+1 ë¬¸ì œë¥¼ batchingì„ í†µí•´ 1+1ë¡œ ë³€í™˜í•´ì£¼ëŠ” libraryì´ë‹¤.
ì£¼ë¡œ ì—ì„œ ë§ì´ ì‚¬ìš©ë˜ì§€ë§Œ GrpahQLì— ì–´ë–¤ ì˜ì¡´ì„±ì„ ê°€ì§€ê³  ìˆì§€ëŠ” ì•Šë‹¤.

## Batching

DataLoaderëŠ” javascriptì˜ event-loop ì„ ì´ìš©í•œë‹¤. ì£¼ìš”ê¸°ëŠ¥ì¸ batchingì€ event-loop ì¤‘ í•˜ë‚˜ì˜ tickì—ì„œ ì‹¤í–‰ëœ data fetchì— ëŒ€í•œ ìš”ì²­ì„ í•˜ë‚˜ì˜ ìš”ì²­ìœ¼ë¡œ ëª¨ì•„ì„œ ì‹¤í–‰í•˜ê³  ê·¸ ê²°ê³¼ë¥¼ ë‹¤ì‹œ ì•Œë§ê²Œ ë¶„ë°°í•˜ëŠ” ì—­í• ì„ í•œë‹¤.

ì•„ë˜ ê°„ë‹¨í•œ ì˜ˆì œë¥¼ ë³´ì.

```javascript
const DataLoader = require('dataloader')

// fake data
const posts = [
  { id: 1, title: 'test1' },
  { id: 2, title: 'test2' },
  { id: 3, title: 'test3' },
  { id: 4, title: 'test4' },
  { id: 5, title: 'test5' },
]

// fake db operation
const findAllPosts = () =>
  new Promise(resolve => {
    setTimeout(() => {
      resolve(posts)
    }, 100)
  })

// batchLoadFn ì˜ ê²°ê³¼ëŠ” promiseì—¬ì•¼ í•œë‹¤.
const batchLoadFn = async keys => {
  const results = await findAllPosts()
  console.log(keys)
  // db ì—ì„œ ë°›ì•„ì˜¨ ê²°ê³¼ë¥¼ ìš”ì²­ì˜¨ keyì— mapping
  return keys.map(k => results.find(p => p.id === k))
}

const postLoader = new DataLoader(batchLoadFn)

// tick 1
postLoader.load(1).then(console.log)
postLoader.load(2).then(console.log)

// tick 2
setTimeout(() => {
  postLoader.load(3).then(console.log)
  postLoader.load(4).then(console.log)
}, 100)
```

DataLoaderì˜ constructorëŠ” batchìš”ì²­ì„ ì–´ë–»ê²Œ ì²˜ë¦¬í• ì§€ì— ëŒ€í•œ `batchLoadFn` ì„ ì¸ìë¡œ ë°›ëŠ”ë‹¤.
ì´ `batchLoadFn`ì˜ ì—­í• ì€ í•˜ë‚˜ì˜ tickì—ì„œ ë“¤ì–´ì˜¨ `key`ë“¤ì— ëŒ€í•œ ìš”ì²­ì„ ëª¨ì•„ì„œ í•˜ë‚˜ì˜ ìš”ì²­ì„ ë§Œë“¤ì–´ DBì— queryí•˜ê³  ê·¸ ê²°ê³¼ë¥¼ ìš”ì²­ì˜¨ keyì— ë§ê²Œ mapping í•œë‹¤.
(ì´ ì˜ˆì œì—ì„œëŠ” í¸ì˜ìƒ memoryìƒì— dataë¥¼ í™œìš©í•˜ì˜€ë‹¤.)

`setTimeout`ì€ event-loop ìƒì— í•˜ë‚˜ì˜ tick ì—ì„œ ì‹¤í–‰ë˜ì§€ ì•Šê³  ë‹¤ìŒìœ¼ë¡œ ì‹¤í–‰ì„ ë¯¸ë£¨ê²Œ ëœë‹¤.

### Output

```text
[1, 2]
[3, 4]

{ id: 1 ... }
{ id: 2 ... }
{ id: 3 ... }
{ id: 4 ... }
```

tick ì´ 2ë²ˆ ë°œìƒí–ˆê¸° ë•Œë¬¸ì— loadë¥¼ 4ë²ˆ í˜¸ì¶œí•˜ì—¬ë„ ì‹¤ì œìš”ì²­ì€ 2ë²ˆë§Œ ì‹¤í–‰ë˜ëŠ”ê±¸ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

ì „ì²´ì ì¸ ë™ì‘ì„ ë‹¤ì‹œ ì •ë¦¬í•˜ë©´ `load` ë¥¼ ê°œë³„ì ìœ¼ë¡œ í˜¸ì¶œí•˜ì§€ë§Œ ì‹¤í–‰ë˜ëŠ” tick ë³„ë¡œ groupingí•´ì„œ batch ìš”ì²­ì„ í•˜ê²Œë˜ê³  ê·¸ ê²°ê³¼ë¥¼ ë‹¤ì‹œ ê°œë³„ì ìœ¼ë¡œ ë‚˜ëˆ ì„œ ë°˜í™˜í•˜ê²Œ ëœë‹¤.
ì¦‰, ë°ì´í„°ë¥¼ lazy loadingí•˜ë©´ì„œ ì„±ëŠ¥ì €í•˜ì˜ ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆë‹¤.

## GraphQLì— DataLoader ì ìš©

ì•„ê¹Œ ë¬¸ì œê°€ ë˜ì—ˆë˜ resolverì— DataLoaderë¥¼ ì ìš©í•´ë³´ì.
comments ì—ì„œ dataë¥¼ fetchingí•˜ëŠ” ë¶€ë¶„ì— DataLoaderë¥¼ ì ìš©í•´ì„œ í•´ê²°í•  ìˆ˜ ìˆë‹¤.

GraphQL ì—ì„œ DataLoaderë¥¼ ì ìš©í•˜ëŠ” ìˆœì„œëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

1. loadí•  dataì— ë”°ë¼ `batchLoadFn` ë¥¼ ì‘ì„±í•œë‹¤.
2. Contextì—ì„œ í•´ë‹¹ DataLoader ê°ì²´ë¥¼ ìƒì„±í•œë‹¤.
3. resolverì—ì„œ contextì˜ DataLoaderë¥¼ í†µí•´ì„œ `load`ë¥¼ í˜¸ì¶œí•œë‹¤.

DataLoaderì˜ instanceëŠ” ìì²´ì ìœ¼ë¡œ `cacheMap` ì„ ê°€ì§€ê³  ìˆë‹¤. ê°™ì€ keyì— ëŒ€í•œ ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´ cachingëœ ê°’ì„ ì‚¬ìš©í•˜ê²Œ ë˜ëŠ”ë° web applicationì—ì„œ ì´ëŸ°ë°©ì‹ì€ ìœ„í—˜í•  ìˆ˜ ìˆë‹¤. ì´ëŸ¬í•œ ì´ìœ ë¡œ ë§¤ requestë§ˆë‹¤ ìƒˆë¡œìš´ DataLoader ê°ì²´ë¥¼ ìƒì„±í•´ì„œ ì‚¬ìš©í•˜ëŠ”ê²ƒì„ ê¶Œì¥í•˜ê³  ìˆë‹¤.

`CommentsLoader`

```javascript
const batchLoadFn = async postIds => {
  const comments = await Comment.find({ where: { postId: In(postIds) } })
  return postIds.map(id => comments.filter(c => c.postId === id))
}

export const commentsLoader = () => new DataLoader(batchLoadFn)
```

`Context`

```javascript
const server = new ApolloServer({
  ...,
  context: () => ({
    loaders: {
      commentsLoader: commentsLoader()
    }
  })
})
```

`Resolver`

```javascript
...
comments: async (root, _, context) => {
  return context.loaders.commentsLoader.load(root.id)
}
```

ìœ„ì™€ê°™ì´ DataLoaderë¥¼ ì ìš©í•˜ë©´ comments resolverì—ì„œì˜ ëª¨ë“  load ìš”ì²­ì€ í•˜ë‚˜ì˜ ìš”ì²­ìœ¼ë¡œ ë¬¶ì—¬ì„œ ì‹¤í–‰ë˜ì„œ ì„±ëŠ¥ë¬¸ì œê°€ í•´ê²°ëœë‹¤. ë˜í•œ dataë¥¼ ì´ˆê¸°ì— ëª¨ë‘ fetchí•˜ì§€ ì•Šê³  lazyí•˜ê²Œ ìœ ì§€í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ì—­í• ì— ë§ê²Œ resolverë¥¼ ë¶„ë¦¬í•´ì„œ ë³µì¡ì„±ì„ ì¤„ì¼ ìˆ˜ ìˆë‹¤.

## ë§ˆì¹˜ë©°

DataLoaderë¥¼ ì ìš©í•˜ëŠ” ê²ƒì€ í° ì–´ë ¤ì›€ì´ ì—†ì—ˆë˜ ê²ƒ ê°™ë‹¤. ì²˜ìŒì—” ë™ì‘ë°©ì‹ì´ ì¢€ ë‚œí•´í•˜ê²Œ ëŠê»´ì¡ŒëŠ”ë° ë¼ì´ë¸ŒëŸ¬ë¦¬ ì½”ë“œë¥¼ ì½ê³ ë‚˜ì„œ ë³´ë‹ˆ Promiseì˜ ì´ì ê³¼ event-loopì˜ íŠ¹ì„±ì„ ì´ìš©í•˜ëŠ” ë¶€ë¶„ì´ ì¸ìƒì ì´ì˜€ë‹¤.

## Ref

- https://github.com/graphql/dataloader
- https://medium.com/gaplabs-engineering/make-more-efficient-requests-with-dataloader-96ff50eb8998
- https://nodejs.org/ko/docs/guides/event-loop-timers-and-nexttick/
- https://engineering.shopify.com/blogs/engineering/solving-the-n-1-problem-for-graphql-through-batching
- https://github.com/typeorm/typeorm/blob/master/docs/eager-and-lazy-relations.md
